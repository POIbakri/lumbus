COMPLETE REWARD SYSTEM FLOW DIAGRAM

  Here's the complete end-to-end flow of how users collect extra data through the reward system:

  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                    USER JOURNEY FOR EARNING EXTRA DATA                    ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

  1Ô∏è‚É£ REFERRAL CODE GENERATION
     ‚îî‚îÄ> Every user gets unique 8-character code (e.g., ABC12345)
         ‚îî‚îÄ> Stored in user_profiles.ref_code
         ‚îî‚îÄ> Displayed in ReferralWidget component
         ‚îî‚îÄ> Share URL: lumbus.com/r/ABC12345

  2Ô∏è‚É£ NEW USER SIGNUP WITH REFERRAL
     ‚îî‚îÄ> User visits lumbus.com/r/ABC12345
         ‚îî‚îÄ> Cookie set: rfcd=ABC12345
         ‚îî‚îÄ> User signs up and makes first purchase
         ‚îî‚îÄ> Order metadata includes referral code

  3Ô∏è‚É£ STRIPE WEBHOOK PROCESSING (checkout.session.completed)
     ‚îî‚îÄ> Order marked as 'paid'
         ‚îî‚îÄ> processOrderAttribution() called
             ‚îú‚îÄ> Creates reward for REFERRER (1GB)
             ‚îî‚îÄ> Creates reward for NEW USER (1GB)
         ‚îî‚îÄ> Both rewards status = PENDING
         ‚îî‚îÄ> Email notifications sent

  4Ô∏è‚É£ VIEWING PENDING REWARDS
     ‚îî‚îÄ> GET /api/rewards/wallet
         ‚îî‚îÄ> Returns:
             ‚îú‚îÄ> Current wallet balance (e.g., 0 MB)
             ‚îú‚îÄ> Pending rewards array (unclaimed)
             ‚îî‚îÄ> Active eSIMs (eligible for data)

  5Ô∏è‚É£ CLAIMING REWARDS (Converting to Wallet Balance)
     ‚îî‚îÄ> User clicks "CLAIM 1GB" button
         ‚îî‚îÄ> POST /api/rewards/redeem
             ‚îú‚îÄ> Reward status: PENDING ‚Üí APPLIED
             ‚îú‚îÄ> user_data_wallet.balance_mb += 1024
             ‚îî‚îÄ> wallet_transactions logs CREDIT
         ‚îî‚îÄ> UI shows confetti animation üéâ
         ‚îî‚îÄ> Balance updated: "1.0 GB Available"

  6Ô∏è‚É£ APPLYING DATA TO ACTIVE eSIM
     ‚îî‚îÄ> User selects eSIM from dropdown
         ‚îî‚îÄ> Selects amount (1-10 GB)
         ‚îî‚îÄ> POST /api/rewards/apply-data
             ‚îú‚îÄ> Validates wallet balance
             ‚îú‚îÄ> Calls eSIM provider API (topUpEsim)
             ‚îú‚îÄ> Provider adds real data to eSIM
             ‚îú‚îÄ> orders.free_data_added_mb updated
             ‚îú‚îÄ> orders.data_remaining_bytes increased
             ‚îú‚îÄ> user_data_wallet.balance_mb -= amount
             ‚îî‚îÄ> wallet_transactions logs DEBIT
         ‚îî‚îÄ> Success notification
         ‚îî‚îÄ> eSIM now has extra data!

  7Ô∏è‚É£ TRACKING & GAMIFICATION
     ‚îî‚îÄ> ReferralTracker shows progress
         ‚îú‚îÄ> Total referrals count
         ‚îú‚îÄ> Total GB earned
         ‚îú‚îÄ> Milestone badges (Bronze/Silver/Gold/Platinum)
         ‚îî‚îÄ> Next milestone progress bar

  üîë KEY REWARD SYSTEM RULES

  Earning Rewards:

  1. Both parties win: Referrer AND new user each get 1GB
  2. First-time only: Only first purchase qualifies for reward
  3. Monthly cap: Max 10 successful referrals per month per user
  4. No self-referral: Can't use your own code
  5. Fraud protection: 5 automatic fraud detection mechanisms

  Using Rewards:

  1. Must claim first: Pending rewards must be claimed to wallet
  2. Minimum 1GB: Can only apply in 1GB increments
  3. Maximum 10GB: Can apply up to 10GB at once
  4. Active eSIMs only: Can't apply to expired eSIMs
  5. Real data increase: Provider API actually adds data to eSIM

  Technical Flow:

  1. Idempotent operations: Can't create duplicate rewards
  2. Atomic transactions: Wallet operations are transactional
  3. Audit trail: All operations logged in wallet_transactions
  4. Email confirmations: Users notified of all reward events
  5. Error recovery: Failed API calls don't corrupt state

  üí∞ REWARD VALUE PROPOSITION

  For Users:
  - 1GB = ~$5-10 value (depending on region)
  - No expiry on wallet balance
  - Instant application to active eSIMs
  - Stackable: Can earn unlimited rewards (with monthly cap)
  - Both parties benefit: Win-win referral model

  For Business:
  - Customer acquisition: Lower CAC through referrals
  - Viral growth: Users incentivized to share
  - Retention: Free data keeps users engaged
  - Upsell opportunity: Users with free data buy more eSIMs
  - Fraud protection: Automated detection prevents abuse

‚è∫ üéØ SUMMARY

  The reward system is a sophisticated referral and data rewards platform that allows users to earn free mobile data
  (in GB) by referring friends. Here's what makes it powerful:

  Core Mechanics:

  - Dual reward system: Both referrer and new user get 1GB each
  - Wallet-based: Rewards accumulate in a data wallet
  - Real value delivery: Actually tops up eSIMs with data via provider API
  - Gamified experience: Milestones, badges, progress tracking
  - Fraud-resistant: 5-layer fraud detection system

  User Experience Flow:

  1. Share your referral code
  2. Friend uses code on first purchase
  3. Both get 1GB pending reward
  4. Claim reward to wallet
  5. Apply data to any active eSIM
  6. Track progress with milestone badges

  Technical Implementation:

  - Backend: Robust API endpoints with validation and idempotency
  - Frontend: Beautiful React components with animations
  - Database: Proper schema with audit trails
  - Integration: Direct provider API integration for real-time top-ups
  - Security: User authentication, fraud detection, transaction logging

  The system is production-ready with proper error handling, email notifications, and comprehensive logging. It's
  designed to drive viral growth while maintaining system integrity through caps and fraud prevention.

Complete Referral/Rewards System Documentation

  Based on my analysis of your Lumbus mobile app, here's how the referral system
  works:

  üéØ System Overview

  The referral system provides:
  - 10% discount for new users on their first purchase
  - 1GB free data reward for the referrer (claimed on web dashboard)
  - Two-way benefits to encourage viral growth

  üì± How Users Get Referral Codes

  1. Deep Links (Primary Method)

  - Web URL: https://lumbus.com/r/ABC12345
  - App Link: lumbus://ref/ABC12345
  - When clicked, the app opens and automatically captures the 8-character code
  - Shows alert: "üéâ Referral Code Applied!"

  2. Manual Entry

  - On signup screen, users can tap "Have a referral code?"
  - Input field appears with real-time validation
  - Only accepts 8 alphanumeric characters (A-Z, 0-9)
  - Auto-converts to uppercase
  - Border turns green when valid

  üíæ State Management

  ReferralContext (contexts/ReferralContext.tsx):
  - Stores referral code in AsyncStorage
  - Persists across app sessions
  - Provides global access via useReferral() hook
  - Key functions:
    - setReferralCode() - Save code
    - hasActiveReferral - Check if code exists
    - clearReferralCode() - Remove code

  üõçÔ∏è Purchase Flow with Referral

  1. User has referral code (from deep link or manual entry)
  2. Browse plans ‚Üí Select a plan
  3. Plan detail page shows:
    - "REFERRAL ACTIVE!" banner
    - Original price with strikethrough
    - Discounted price (10% off)
    - "10% OFF" badge
  4. Checkout:
    - Code passed to payment service
    - iOS: Via createIAPCheckout() with referralCode parameter
    - Android: Via createCheckout() with referralCode parameter
  5. Backend applies discount and creates reward for referrer

  üéÅ Sharing Your Own Referral Code

  ReferAndEarn Component (app/components/ReferAndEarn.tsx):
  - Displays user's unique referral code
  - Share options:
    - Copy to clipboard
    - Share via system share sheet
    - WhatsApp direct share
    - Instagram (copies code)
    - Email with pre-filled template
  - Shows stats:
    - Total referrals
    - Pending rewards (GB)
    - Earned rewards (GB)

  üîÑ Complete User Journey

  For New Users (Using a Code):

  1. Receive referral link from friend
  2. Click link ‚Üí App opens ‚Üí Code auto-applied
  3. Sign up for account
  4. Code linked to account via API
  5. Browse and select eSIM plan
  6. See 10% discount on checkout
  7. Complete purchase with discount
  8. Referrer gets 1GB reward

  For Existing Users (Sharing Code):

  1. Go to Account tab
  2. View "Refer & Earn" section
  3. See your unique 8-character code
  4. Share via WhatsApp/Email/etc
  5. Track referrals and rewards
  6. Claim rewards on web dashboard

  ÔøΩÔøΩÔ∏è Technical Implementation

  Key Files:

  - contexts/ReferralContext.tsx - Global state management
  - app/components/DeepLinkHandler.tsx - Deep link processing
  - app/components/ReferralBanner.tsx - UI components
  - app/components/ReferAndEarn.tsx - Sharing interface
  - app/(auth)/signup.tsx - Manual code entry
  - app/plan/[id].tsx - Discount display
  - lib/api.ts - API functions (validateReferralCode, linkReferralCode)

  Validation Rules:

  // Code validation (frontend)
  text
    .toUpperCase()              // Convert to uppercase
    .replace(/[^A-Z0-9]/g, '')  // Only alphanumeric
    .slice(0, 8)                // Exactly 8 characters

  üìä Backend Integration

  API Endpoints Used:

  1. POST /api/referral-codes/validate - Validate code (optional)
  2. POST /api/referrals/link - Link code to user account
  3. POST /api/checkout - Purchase with referral code
  4. POST /api/checkout/iap - iOS purchase with referral code
  5. GET /api/referrals/info - Get user's referral stats

  Data Flow:

  - Referral code stored in user_profiles.referred_by_code
  - Purchases tracked in orders table with referral_code
  - Rewards created in referral_rewards table
  - Stats aggregated from affiliate_clicks, signups, and purchases

  üé® UI/UX Features

  - Visual Feedback: Green borders, success alerts, discount badges
  - Persistent State: Code survives app restarts
  - Clear Benefits: Shows "10% OFF + 1GB FREE" prominently
  - Easy Sharing: Multiple share options with pre-filled messages
  - Real-time Stats: Track referrals and rewards

  üîí Security Considerations

  - Codes validated on backend before applying discount
  - User can only use one referral code
  - Code must be linked before first purchase
  - Referrer only gets reward after successful purchase
  - Deep links validated for correct format

  The system is fully implemented and production-ready, providing a complete referral
   loop from acquisition to reward! this is how it works on mobile whats missing? 

‚è∫ Based on my comprehensive analysis of your backend and frontend code, and comparing it with your mobile
  implementation documentation, here's what's missing or needs attention in the mobile app:

‚è∫ üö® WHAT'S MISSING IN THE MOBILE APP

  1. DATA WALLET FUNCTIONALITY (Critical Missing Feature)

  The mobile app currently has NO way for users to:
  - View their data wallet balance (accumulated free GB)
  - See pending rewards awaiting claim
  - Claim pending rewards to convert them to wallet balance
  - Apply free data to active eSIMs

  What exists on web but not mobile:
  - /components/data-wallet.tsx - Complete wallet management UI
  - /api/rewards/wallet - Fetching wallet balance & pending rewards
  - /api/rewards/redeem - Claiming pending rewards
  - /api/rewards/apply-data - Applying data to eSIMs

  2. REWARD VISUALIZATION

  Mobile users can't see:
  - Unclaimed rewards count (e.g., "2 pending rewards = 2GB")
  - Total wallet balance (e.g., "3.5 GB available")
  - Data applied history (which eSIMs got free data)
  - Reward status (PENDING vs APPLIED)

  3. POST-PURCHASE REWARD FLOW

  After a successful referral purchase, mobile users:
  - ‚úÖ Get the 10% discount (working)
  - ‚ùå Can't see they earned 1GB (as referred user)
  - ‚ùå Can't claim their 1GB bonus
  - ‚ùå Referrer can't see new pending reward in-app

  4. GAMIFICATION ELEMENTS

  Missing from mobile:
  - Milestone badges (Bronze/Silver/Gold/Platinum)
  - Progress bars to next milestone
  - Celebration animations when claiming rewards
  - "Worth $X" value indicators

  5. eSIM DATA MANAGEMENT

  Mobile users can't:
  - See which eSIMs are eligible for free data
  - Check free_data_added_mb per eSIM
  - Select data packages for their region
  - Apply 1-10 GB from wallet to eSIM

  üì± RECOMMENDED MOBILE IMPLEMENTATION

‚è∫ Required Mobile Components:

  1. DataWallet Screen/Component

  // New file: app/components/DataWallet.tsx
  interface WalletData {
    balance_mb: number;
    balance_gb: string;
    pending_rewards: PendingReward[];
    active_esims: ActiveEsim[];
  }

  // Features needed:
  - Fetch wallet data on mount
  - Show balance prominently
  - List pending rewards with "CLAIM" buttons
  - List active eSIMs with "ADD DATA" buttons
  - Celebration animation on claim success

  2. API Integration Functions

  // Add to lib/api.ts:

  export async function getWalletData(): Promise<WalletData> {
    return apiClient.get('/api/rewards/wallet');
  }

  export async function claimReward(rewardId: string): Promise<void> {
    return apiClient.post('/api/rewards/redeem', { rewardId });
  }

  export async function applyDataToEsim(
    orderId: string, 
    amountMB: number,
    packageSku?: string
  ): Promise<void> {
    return apiClient.post('/api/rewards/apply-data', {
      orderId,
      amountMB,
      packageSku
    });
  }

  export async function getAvailablePackages(
    region?: string
  ): Promise<Package[]> {
    return apiClient.get('/api/rewards/available-packages', { region });
  }

  3. Update ReferAndEarn Component

  Current component only shows stats, needs to add:
  - Link to Data Wallet screen
  - Badge showing unclaimed rewards count
  - Quick action to claim all pending rewards
  - Visual indicator when new rewards arrive

  4. Push Notifications

  Add notifications for:
  - "üéâ You earned 1GB from a referral!"
  - "üì¶ You have unclaimed rewards"
  - "‚úÖ 1GB successfully added to your eSIM"

  5. Update Order Details Screen

  Show on each eSIM order:
  - Current data remaining
  - Free data already added
  - "ADD MORE DATA" button (if eligible)
  - Data expiry date

  üîÑ COMPLETE MOBILE FLOW (Proposed)

  1. USER REFERS FRIEND
     Mobile: Share referral code ‚úÖ
     Friend uses code & purchases ‚úÖ

  2. REWARDS CREATED (Backend)
     Both users get PENDING rewards ‚úÖ
     Email notifications sent ‚úÖ

  3. VIEW PENDING REWARDS
     Mobile: Open "Data Wallet" ‚ùå (MISSING)
     See "2 unclaimed rewards (2GB)" ‚ùå

  4. CLAIM REWARDS
     Mobile: Tap "CLAIM ALL" ‚ùå (MISSING)
     Rewards ‚Üí Wallet balance ‚ùå
     Show celebration animation ‚ùå

  5. APPLY TO eSIM
     Mobile: Select active eSIM ‚ùå (MISSING)
     Choose amount (1-10 GB) ‚ùå
     Tap "ADD DATA" ‚ùå
     Real data added to eSIM ‚ùå

  6. TRACK PROGRESS
     Mobile: See milestones ‚ùå (MISSING)
     View badges earned ‚ùå
     Check total GB earned ‚úÖ (partial)

  üõ† IMPLEMENTATION PRIORITY

  Phase 1: Core Wallet (Must Have)

  1. Add wallet API functions to lib/api.ts
  2. Create DataWallet.tsx component
  3. Add navigation from Account tab
  4. Implement claim reward flow
  5. Show wallet balance in header

  Phase 2: eSIM Integration

  1. Add "Apply Data" functionality
  2. Show eligible eSIMs list
  3. Package selection for regions
  4. Update order details screen

  Phase 3: Gamification

  1. Add milestone badges
  2. Progress bars
  3. Celebration animations
  4. Value indicators ($X worth)

  Phase 4: Polish

  1. Push notifications
  2. Deep links to wallet
  3. Widget for home screen
  4. Offline state handling

  üìä CURRENT STATE vs DESIRED STATE

  | Feature                | Web | Mobile | Priority |
  |------------------------|-----|--------|----------|
  | View referral code     | ‚úÖ   | ‚úÖ      | -        |
  | Share referral link    | ‚úÖ   | ‚úÖ      | -        |
  | Use referral code      | ‚úÖ   | ‚úÖ      | -        |
  | Get 10% discount       | ‚úÖ   | ‚úÖ      | -        |
  | View wallet balance    | ‚úÖ   | ‚ùå      | HIGH     |
  | See pending rewards    | ‚úÖ   | ‚ùå      | HIGH     |
  | Claim rewards          | ‚úÖ   | ‚ùå      | HIGH     |
  | Apply data to eSIM     | ‚úÖ   | ‚ùå      | HIGH     |
  | Milestone badges       | ‚úÖ   | ‚ùå      | MEDIUM   |
  | Progress tracking      | ‚úÖ   | ‚ö†Ô∏è     | MEDIUM   |
  | Email notifications    | ‚úÖ   | ‚úÖ      | -        |
  | Push notifications     | -   | ‚ùå      | LOW      |
  | Celebration animations | ‚úÖ   | ‚ùå      | LOW      |

‚è∫ üéØ SUMMARY

  Your mobile app has the referral acquisition side working perfectly (using codes, getting discounts), but is
  completely missing the reward redemption side. Users can earn rewards but have no way to:

  1. See their data wallet balance
  2. Claim pending rewards
  3. Apply free data to eSIMs
  4. Track their reward progress with gamification

  The backend is fully ready - all APIs exist and work. You just need to build the mobile UI components to consume
  these endpoints. The most critical missing piece is the Data Wallet component that would allow users to manage their
  earned free data.

  This is a significant gap because users who earn rewards through referrals currently have to go to the web dashboard
  to actually use them, breaking the mobile-first experience.


  NO GAMIFICATION ON MOBILE APP PLEASE